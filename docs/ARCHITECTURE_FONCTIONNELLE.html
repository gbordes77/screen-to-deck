<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Screen‑to‑Deck — Architecture Fonctionnelle (avec graphiques)</title>
  <style>
    :root { --ink:#0f172a; --muted:#475569; --line:#e2e8f0; --bg:#ffffff; --pill:#eef2ff; --pillink:#3730a3; }
    * { box-sizing: border-box; }
    body { font-family: -apple-system, system-ui, Segoe UI, Roboto, Helvetica, Arial, sans-serif; line-height: 1.55; color: var(--ink); background: var(--bg); margin: 2rem; }
    h1 { font-size: 1.9rem; margin: 0 0 .25rem 0; }
    h2 { font-size: 1.35rem; margin: 2rem 0 .5rem; }
    h3 { font-size: 1.05rem; margin: 1.25rem 0 .35rem; }
    p { margin: .35rem 0; }
    code, pre { background: #f1f5f9; padding: .2rem .35rem; border-radius: 4px; }
    pre { padding: .75rem; overflow: auto; }
    .muted { color: var(--muted); }
    .pill { background: var(--pill); color: var(--pillink); padding: 2px 8px; border-radius: 999px; font-size: .85rem; }
    .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 12px; }
    .card { border: 1px solid var(--line); border-radius: 10px; padding: 12px; background: #fff; }
    .legend { display: inline-grid; grid-template-columns: auto 1fr; gap: 4px 10px; align-items:center; }
    .legend .dot { width: 12px; height: 12px; border-radius: 50%; display:inline-block; }
    .btns a { display:inline-block; margin-right:8px; padding:6px 10px; border:1px solid var(--line); border-radius:8px; text-decoration:none; color:#0f172a; }
    .caption { font-size:.9rem; color:var(--muted); margin-top:.35rem; }
    svg { max-width: 100%; height: auto; }
  </style>
</head>
<body>
  <h1>Screen‑to‑Deck — Architecture Fonctionnelle</h1>
  <p class="muted">Monorepo: Client React/Vite • Serveur Express/TypeScript • Bot Discord (Python) • Queue BullMQ/Redis • OCR OpenAI/EasyOCR • Scryfall • Observabilité/Docs</p>

  <div class="btns">
    <a href="#contexte">Contexte</a>
    <a href="#graph-contexte">Graphique 1</a>
    <a href="#graph-flux">Graphique 2</a>
    <a href="#graph-deploiement">Graphique 3</a>
  </div>

  <h2 id="contexte">Vue d’ensemble</h2>
  <div class="grid">
    <div class="card">
      <strong>Client Web</strong>
      <ul>
        <li>React + Vite, port <code>5173</code></li>
        <li>Upload → <code>/api/ocr/upload</code></li>
        <li>Statut → <code>/api/ocr/status/:id</code></li>
        <li>Export → <code>/api/export/:format</code></li>
      </ul>
    </div>
    <div class="card">
      <strong>API Serveur</strong>
      <ul>
        <li>Express TS, port <code>3001</code>, <span class="pill">/api/docs</span></li>
        <li>CSP (helmet), CORS, rate‑limit, budgetGuard</li>
        <li>Prometheus <span class="pill">/metrics</span>, Pino logs</li>
      </ul>
    </div>
    <div class="card">
      <strong>File d’attente</strong>
      <ul>
        <li>BullMQ + Redis (retries, persistance)</li>
        <li>Workers OCR (concurrence configurable)</li>
      </ul>
    </div>
    <div class="card">
      <strong>OCR & Canonicalisation</strong>
      <ul>
        <li>OCR: OpenAI Vision (online) ou EasyOCR/Tesseract (offline)</li>
        <li>Validation: Scryfall (batch via <code>/cards/collection</code>)</li>
      </ul>
    </div>
  </div>

  <h2 id="graph-contexte">Graphique 1 — Diagramme de contexte</h2>
  <svg viewBox="0 0 1050 420" role="img" aria-labelledby="ctxTitle ctxDesc">
    <title id="ctxTitle">Contexte Screen‑to‑Deck</title>
    <desc id="ctxDesc">Client Web et Bot Discord interagissent avec API, qui parle à Redis, OpenAI et Scryfall.</desc>
    <defs>
      <linearGradient id="g1" x1="0" y1="0" x2="1" y2="1">
        <stop offset="0%" stop-color="#eef2ff"/>
        <stop offset="100%" stop-color="#e2e8f0"/>
      </linearGradient>
      <filter id="shadow" x="-10%" y="-10%" width="120%" height="120%">
        <feDropShadow dx="0" dy="1" stdDeviation="2" flood-color="#94a3b8" flood-opacity=".35" />
      </filter>
      <style>
        .box{fill:#fff;stroke:#cbd5e1;stroke-width:1.2;filter:url(#shadow);}
        .title{font:600 14px/1.2 -apple-system,system-ui,Segoe UI,Roboto,Helvetica,Arial; fill:#0f172a}
        .sub{font:12px/1.35 -apple-system,system-ui,Segoe UI,Roboto,Helvetica,Arial; fill:#475569}
        .arrow{stroke:#64748b; stroke-width:2; marker-end:url(#mEnd)}
      </style>
      <marker id="mEnd" markerWidth="10" markerHeight="10" refX="8" refY="3" orient="auto" markerUnits="strokeWidth">
        <path d="M0,0 L8,3 L0,6 Z" fill="#64748b" />
      </marker>
    </defs>

    <!-- Nodes -->
    <rect class="box" x="40" y="50" width="260" height="90" rx="10"/>
    <text class="title" x="60" y="78">Client Web (React/Vite)</text>
    <text class="sub" x="60" y="100">Port 5173 · Upload/Status/Export</text>

    <rect class="box" x="40" y="190" width="260" height="90" rx="10"/>
    <text class="title" x="60" y="218">Bot Discord (Python)</text>
    <text class="sub" x="60" y="240">Images via Discord · OCR/Export</text>

    <rect class="box" x="360" y="120" width="300" height="130" rx="10"/>
    <text class="title" x="380" y="150">API Serveur (Express/TS)</text>
    <text class="sub" x="380" y="172">/api/* · Rate‑limit · budgetGuard · /metrics · /api/docs</text>

    <rect class="box" x="710" y="40" width="280" height="90" rx="10"/>
    <text class="title" x="730" y="70">OpenAI Vision</text>
    <text class="sub" x="730" y="92">OCR en ligne (si OFFLINE_MODE=false)</text>

    <rect class="box" x="710" y="160" width="280" height="90" rx="10"/>
    <text class="title" x="730" y="190">Scryfall API</text>
    <text class="sub" x="730" y="212">Validation/Enrichissement cartes</text>

    <rect class="box" x="710" y="280" width="280" height="90" rx="10"/>
    <text class="title" x="730" y="310">Redis</text>
    <text class="sub" x="730" y="332">BullMQ · quotas · cache</text>

    <!-- Edges -->
    <path class="arrow" d="M300,95 L360,145" />
    <path class="arrow" d="M300,235 L360,205" />

    <path class="arrow" d="M660,160 L710,85" />
    <path class="arrow" d="M660,185 L710,205" />
    <path class="arrow" d="M660,230 L710,305" />

    <!-- Legend -->
    <rect x="40" y="310" width="520" height="60" rx="10" fill="url(#g1)" stroke="#cbd5e1" />
    <text class="title" x="55" y="335">Légende</text>
    <g class="sub" transform="translate(55,348)">
      <circle r="5" cx="6" cy="6" fill="#64748b" />
      <text x="18" y="10">Flux HTTP/HTTPS</text>
      <text x="160" y="10">Côté serveur: quotas, retry, persistance</text>
    </g>
  </svg>
  <p class="caption">Le client et le bot utilisent la même API; l’API orchestre OCR, Scryfall et file d’attente Redis.</p>

  <h2 id="graph-flux">Graphique 2 — Flux de traitement (OCR)</h2>
  <svg viewBox="0 0 1050 420" role="img" aria-labelledby="flowTitle flowDesc">
    <title id="flowTitle">Flux de traitement OCR</title>
    <desc id="flowDesc">Upload → Queue → Worker OCR → OpenAI/EasyOCR → Scryfall → statut</desc>
    <style>
      .swim{fill:#fff;stroke:#cbd5e1;stroke-width:1.2}
      .step{fill:#f8fafc;stroke:#cbd5e1}
      .lbl{font:600 13px -apple-system,system-ui,Segoe UI,Roboto,Helvetica,Arial; fill:#0f172a}
      .sub{font:12px -apple-system,system-ui,Segoe UI,Roboto,Helvetica,Arial; fill:#475569}
      .flow{stroke:#64748b; stroke-width:2; marker-end:url(#mEnd2)}
    </style>
    <defs>
      <marker id="mEnd2" markerWidth="10" markerHeight="10" refX="8" refY="3" orient="auto" markerUnits="strokeWidth">
        <path d="M0,0 L8,3 L0,6 Z" fill="#64748b" />
      </marker>
    </defs>

    <!-- Lanes -->
    <rect class="swim" x="20" y="20" width="1010" height="90" rx="10" />
    <text class="lbl" x="30" y="45">UI / Bot</text>
    <rect class="swim" x="20" y="130" width="1010" height="90" rx="10" />
    <text class="lbl" x="30" y="155">API</text>
    <rect class="swim" x="20" y="240" width="1010" height="160" rx="10" />
    <text class="lbl" x="30" y="265">Workers & Services</text>

    <!-- Steps -->
    <rect class="step" x="160" y="45" width="170" height="40" rx="6" />
    <text class="sub" x="172" y="70">Upload image</text>

    <rect class="step" x="360" y="155" width="210" height="40" rx="6" />
    <text class="sub" x="372" y="180">Enqueue job (BullMQ)</text>

    <rect class="step" x="640" y="270" width="210" height="40" rx="6" />
    <text class="sub" x="652" y="295">OCR (OpenAI/EasyOCR)</text>

    <rect class="step" x="640" y="320" width="210" height="40" rx="6" />
    <text class="sub" x="652" y="345">Validation Scryfall</text>

    <rect class="step" x="880" y="155" width="130" height="40" rx="6" />
    <text class="sub" x="892" y="180">Status update</text>

    <!-- Arrows -->
    <path class="flow" d="M330,65 L360,175" />
    <path class="flow" d="M570,175 L640,290" />
    <path class="flow" d="M745,310 L745,320" />
    <path class="flow" d="M745,360 L945,175" />
    <path class="flow" d="M220,85 L220,120 L900,120 L900,155" />
  </svg>
  <p class="caption">Le statut évolue jusqu’à <em>completed</em> ou <em>failed</em>; l’UI/bot récupère le résultat et propose l’export.</p>

  <h2 id="graph-deploiement">Graphique 3 — Déploiement (prod docker)</h2>
  <svg viewBox="0 0 1050 420" role="img" aria-labelledby="depTitle depDesc">
    <title id="depTitle">Déploiement</title>
    <desc id="depDesc">Nginx (client static), API Node, Redis; sécurité et healthchecks</desc>
    <style>
      .host{fill:#ffffff;stroke:#cbd5e1;stroke-width:1.5}
      .ctr{fill:#f8fafc;stroke:#cbd5e1}
      .ttl{font:600 14px -apple-system,system-ui,Segoe UI,Roboto,Helvetica,Arial; fill:#0f172a}
      .txt{font:12px -apple-system,system-ui,Segoe UI,Roboto,Helvetica,Arial; fill:#475569}
    </style>

    <rect class="host" x="30" y="40" width="990" height="330" rx="12" />
    <text class="ttl" x="50" y="65">Host / Cluster</text>

    <rect class="ctr" x="60" y="90" width="280" height="250" rx="10" />
    <text class="ttl" x="80" y="115">Nginx</text>
    <text class="txt" x="80" y="135">• Sert client static</text>
    <text class="txt" x="80" y="153">• Reverse proxy /api → API</text>

    <rect class="ctr" x="370" y="90" width="300" height="250" rx="10" />
    <text class="ttl" x="390" y="115">API (Node/Express)</text>
    <text class="txt" x="390" y="135">• /health /api/health /metrics</text>
    <text class="txt" x="390" y="153">• CSP, CORS, Rate‑limit</text>
    <text class="txt" x="390" y="171">• BullMQ workers</text>

    <rect class="ctr" x="700" y="90" width="280" height="250" rx="10" />
    <text class="ttl" x="720" y="115">Redis</text>
    <text class="txt" x="720" y="135">• Jobs, quotas, cache</text>

    <text class="txt" x="50" y="385">Secrets hors repo (Keychain/ENV) · Users non‑root · Healthchecks docker · OpenAPI exposé</text>
  </svg>

  <h2>Sécurité & Observabilité</h2>
  <ul>
    <li><strong>CSP</strong> via helmet; <strong>CORS</strong> strict; <strong>rate‑limit</strong> + <strong>budgetGuard</strong></li>
    <li><strong>Prometheus</strong> <code>/metrics</code>; logs Pino corrélés (request‑id)</li>
    <li>Pas de secrets en repo; injection via trousseau macOS / ENV</li>
  </ul>

  <h2>Endpoints clefs</h2>
  <ul>
    <li>OCR: <code>POST /api/ocr/upload</code> · Statut: <code>GET /api/ocr/status/:id</code></li>
    <li>Export: <code>POST /api/export/:format</code> (<code>mtga|moxfield|archidekt|tappedout|txt</code>)</li>
    <li>Docs: <code>/api/docs</code> · Health: <code>/health</code>, <code>/api/health</code> · Metrics: <code>/metrics</code></li>
  </ul>

  <h2>Scripts</h2>
  <ul>
    <li>Arrivée: <code>./scripts/arrivee.sh</code></li>
    <li>One‑button web: <code>./scripts/one-button.sh</code></li>
    <li>One‑button bot: <code>./scripts/one-button-bot.sh</code></li>
  </ul>

  <p class="muted">Voir aussi: <code>PROJECT_OVERVIEW.md</code>, <code>ARCHITECTURE.md</code>, <code>SELF_HOSTING.md</code>, <code>DEVELOPMENT.md</code></p>
</body>
</html>
